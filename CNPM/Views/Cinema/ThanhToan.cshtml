@model XUAT_CHIEU

@{
    ViewBag.Title = "Thanh Toán";
    Layout = "~/Views/Shared/_KhachHangLayout.cshtml";

    var phim = Model.PHIM;
    var phong = Model.PHONG_CHIEU;
    var rap = phong.RAP_PHIM;

    var soLuongVe = ViewBag.SoLuongVe ?? 0;
    var tongTien = ViewBag.TongTien ?? 0m;
    var gheList = ViewBag.GheList as List<string> ?? new List<string>();
    var danhSachGhe = ViewBag.DanhSachGhe as string ?? "";
}

<style>
    .payment-container {
        background: #590808; /* Đổi từ gradient tím sang đỏ 590808 */
        padding: 40px 0;
        min-height: 100vh;
    }

    .payment-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 30px;
        margin-bottom: 30px;
    }

    .payment-header {
        text-align: center;
        margin-bottom: 30px;
        color: #333;
    }

    .movie-info-section {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }

    .movie-poster-container {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        height: 300px;
    }

    .movie-poster {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .info-label {
        font-weight: 600;
        color: #555;
        min-width: 120px;
        display: inline-block;
    }

    .info-value {
        color: #333;
        font-weight: 500;
    }

    .payment-methods {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .payment-method {
        flex: 1;
        min-width: 150px;
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

        .payment-method:hover {
            border-color: #590808; /* Đổi sang màu đỏ */
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(89, 8, 8, 0.1); /* Shadow màu đỏ nhạt */
        }

        .payment-method.selected {
            border-color: #590808; /* Đổi sang màu đỏ */
            background: linear-gradient(135deg, rgba(89, 8, 8, 0.1) 0%, rgba(58, 5, 5, 0.1) 100%); /* Màu đỏ với opacity */
        }

    .method-icon {
        font-size: 40px;
        margin-bottom: 10px;
        display: block;
    }

    .method-name {
        font-weight: 600;
        color: #333;
    }

    .terms-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 25px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
    }

    .terms-header {
        font-weight: 700;
        color: #333;
        margin-bottom: 15px;
        font-size: 16px;
    }

    .terms-content {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
    }

    .checkbox-container {
        display: flex;
        align-items: flex-start;
        margin: 25px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }

        .checkbox-container input[type="checkbox"] {
            margin-top: 3px;
            margin-right: 10px;
            transform: scale(1.2);
        }

    .checkbox-label {
        color: #333;
        font-size: 14px;
        line-height: 1.5;
    }

    .total-section {
        background: linear-gradient(135deg, #590808 0%, #3a0505 100%); /* Đổi sang gradient đỏ */
        border-radius: 10px;
        padding: 20px;
        color: white;
        margin: 25px 0;
    }

    .total-label {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .total-amount {
        font-size: 32px;
        font-weight: 700;
    }

    .confirm-btn {
        background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 50px;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(255, 65, 108, 0.3);
    }

        .confirm-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 65, 108, 0.4);
        }

        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

    .seat-badge {
        display: inline-block;
        background: #590808; /* Đổi sang màu đỏ */
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        margin: 2px;
        font-size: 14px;
    }

    /* Success Modal */
    .success-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

        .success-modal.show {
            opacity: 1;
            visibility: visible;
        }

    .success-content {
        background: white;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        transform: scale(0.9);
        transition: transform 0.3s;
    }

    .success-modal.show .success-content {
        transform: scale(1);
    }

    .success-icon {
        font-size: 80px;
        color: #4CAF50;
        margin-bottom: 20px;
    }

    .success-title {
        font-size: 28px;
        color: #333;
        margin-bottom: 15px;
        font-weight: 700;
    }

    .success-message {
        color: #666;
        margin-bottom: 30px;
        line-height: 1.6;
    }

    .close-btn {
        background: linear-gradient(135deg, #590808 0%, #3a0505 100%); /* Đổi sang gradient đỏ */
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }

        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(89, 8, 8, 0.3); /* Shadow màu đỏ */
        }

    /* Thêm style cho phần info-label có thể thêm màu đỏ nếu muốn */
    .movie-info-section h4 {
        color: #590808 !important; /* Màu đỏ cho tiêu đề */
    }
</style>

<div class="payment-container">
    <div class="container">
        <div class="payment-card">
            <div class="payment-header">
                <h1 style="color: #590808;">THANH TOÁN</h1> <!-- Thêm màu đỏ cho tiêu đề -->
            </div>

            <div class="row">
                <!-- Cột trái: Thông tin phim và ghế -->
                <div class="col-lg-8">
                    <div class="movie-info-section">
                        <h4 class="mb-4">Thông Tin Đặt Vé</h4>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <span class="info-label">Tên Phim:</span>
                                    <span class="info-value">@phim.TenPhim</span>
                                </div>
                                <div class="mb-3">
                                    <span class="info-label">Ngày Chiếu:</span>
                                    <span class="info-value">@Model.NgayChieu.ToString("dd/MM/yyyy")</span>
                                </div>
                                <div class="mb-3">
                                    <span class="info-label">Suất Chiếu:</span>
                                    <span class="info-value">@Model.GioChieu.ToString(@"hh\:mm")</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <span class="info-label">Rạp Chiếu:</span>
                                    <span class="info-value">@rap.TenRap</span>
                                </div>
                                <div class="mb-3">
                                    <span class="info-label">Phòng Chiếu:</span>
                                    <span class="info-value">@phong.TenPhong</span>
                                </div>
                                <div class="mb-3">
                                    <span class="info-label">Ghế:</span>
                                    <div class="mt-2">
                                        @foreach (var ghe in gheList)
                                        {
                                            <span class="seat-badge">@ghe</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phương thức thanh toán -->
                    <div class="mt-4">
                        <h5 class="mb-3">Chọn Phương Thức Thanh Toán</h5>
                        <div class="payment-methods">
                            <div class="payment-method" data-method="credit">
                                <div class="method-icon">💳</div>
                                <div class="method-name">Thẻ tín dụng</div>
                            </div>
                            <div class="payment-method" data-method="debit">
                                <div class="method-icon">🏦</div>
                                <div class="method-name">Thẻ nội địa</div>
                            </div>
                            <div class="payment-method" data-method="ewallet">
                                <div class="method-icon">📱</div>
                                <div class="method-name">Ví điện tử</div>
                            </div>
                        </div>
                    </div>

                    <!-- Điều khoản -->
                    <div class="terms-container">
                        <div class="terms-header">ĐIỀU KIỆN VÀ ĐIỀU KHOẢN ĐẶT VÉ</div>
                        <div class="terms-content">
                            <p>Xin vui lòng đọc các điều khoản sau cẩn thận trước khi sử dụng dịch vụ thanh toán trực tuyến. Với việc truy cập vào phần này của website, bạn đã đồng ý với các điều khoản sử dụng của chúng tôi. Các điều khoản này có thể thay đổi theo thời gian và bạn sẽ phải tuân theo các điều khoản được hiển thị từ thời điểm bạn đọc được các điều khoản này.</p>
                            <p>N13 Cinema luôn luôn mong muốn đem đến những giây phút giải trí tuyệt vời cho khách hàng với chất lượng dịch vụ tốt nhất. Dưới đây sẽ là một số hướng dẫn cho chính sách thanh toán vé trực tuyến.</p>
                        </div>
                    </div>

                    <!-- Checkbox cam kết -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="agreeTerms">
                        <label for="agreeTerms" class="checkbox-label">
                            Cam kết mua vé xem phim cho người xem ở độ tuổi quy định và đồng ý với các Điều Kiện và Điều Khoản.
                        </label>
                    </div>
                </div>

                <!-- Cột phải: Ảnh phim và tổng tiền -->
                <div class="col-lg-4">
                    <div class="movie-poster-container mb-4">
                        <img src="@Url.Content("~/Content/HinhAnh/" + phim.AnhBia)"
                             class="movie-poster"
                             alt="@phim.TenPhim">
                    </div>

                    <div class="total-section">
                        <div class="total-label">TỔNG TIỀN</div>
                        <div class="total-amount">@tongTien.ToString("N0") đ</div>
                        <div class="mt-2" style="font-size: 14px;">
                            (@soLuongVe vé × @Model.GiaVe.ToString("N0") đ)
                        </div>
                    </div>

                    <button class="confirm-btn" id="btnXacNhanThanhToan" disabled>
                        <i class="fas fa-check-circle me-2"></i>XÁC NHẬN THANH TOÁN
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo thành công -->
<div class="success-modal" id="successModal">
    <div class="success-content">
        <div class="success-icon">✓</div>
        <div class="success-title">Thanh toán thành công!</div>
        <div class="success-message">
            Cảm ơn chân thành nhất từ N13 CINEMA!<br>
            Chúc quý khách xem phim vui vẻ.
        </div>
        <button class="close-btn" id="btnCloseModal">Đóng</button>
    </div>
</div>

<script>
$(document).ready(function() {
    var selectedMethod = null;

    // Xử lý chọn phương thức thanh toán
    $('.payment-method').click(function() {
        $('.payment-method').removeClass('selected');
        $(this).addClass('selected');
        selectedMethod = $(this).data('method');
        checkButton();
    });

    // Xử lý checkbox điều khoản
    $('#agreeTerms').change(function() {
        checkButton();
    });

    // Kiểm tra điều kiện để kích hoạt nút
    function checkButton() {
        var isAgreed = $('#agreeTerms').is(':checked');
        if (selectedMethod && isAgreed) {
            $('#btnXacNhanThanhToan').prop('disabled', false);
        } else {
            $('#btnXacNhanThanhToan').prop('disabled', true);
        }
    }

    // Xử lý xác nhận thanh toán
    $('#btnXacNhanThanhToan').click(function() {
        var idXuatChieu = @Model.IDXuatChieu;
        var danhSachGhe = '@Html.Raw(danhSachGhe)';

        if (!selectedMethod) {
            alert('Vui lòng chọn phương thức thanh toán!');
            return;
        }

        // Hiển thị loading
        $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>ĐANG XỬ LÝ...');
        $(this).prop('disabled', true);

        // Gửi AJAX để xử lý thanh toán
        $.ajax({
            url: '@Url.Action("XuLyThanhToan", "Cinema")',
            type: 'POST',
            data: {
                idXuatChieu: idXuatChieu,
                danhSachGhe: danhSachGhe,
                phuongThucThanhToan: selectedMethod
            },
            success: function(response) {
                if (response.success) {
                    // Hiển thị modal thành công
                    $('#successModal').addClass('show');

                    // Sau 3 giây, chuyển hướng về trang chủ
                    setTimeout(function() {
                        window.location.href = '@Url.Action("Index", "Cinema")';
                    }, 3000);
                } else {
                    alert(response.message);
                    $('#btnXacNhanThanhToan').html('<i class="fas fa-check-circle me-2"></i>XÁC NHẬN THANH TOÁN');
                    $('#btnXacNhanThanhToan').prop('disabled', false);
                }
            },
            error: function() {
                alert('Có lỗi xảy ra khi kết nối đến server!');
                $('#btnXacNhanThanhToan').html('<i class="fas fa-check-circle me-2"></i>XÁC NHẬN THANH TOÁN');
                $('#btnXacNhanThanhToan').prop('disabled', false);
            }
        });
    });

    // Đóng modal
    $('#btnCloseModal').click(function() {
        $('#successModal').removeClass('show');
        window.location.href = '@Url.Action("Index", "Cinema")';
    });
});
</script>